name: Release

on:
    push:
        branches: [main]
        paths:
            - "Cargo.toml"
            - "src/**"
            - ".github/workflows/release.yml"

permissions:
    contents: write

jobs:
    release:
        name: Build, Release, and Publish
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - uses: Swatinem/rust-cache@v2
              with:
                  cache-directories: target

            - name: Install wasm-pack and cargo-release
              run: |
                  cargo install wasm-pack
                  cargo install cargo-release

            - name: Extract version from Cargo.toml
              id: version
              run: |
                  VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$VERSION" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Version: $VERSION"

            - name: Check if tag already exists
              id: check_tag
              run: |
                  if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "âš ï¸  Tag v${{ steps.version.outputs.version }} already exists"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "âœ… Tag v${{ steps.version.outputs.version }} does not exist, proceeding"
                  fi

            - name: Configure git for cargo-release
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update CHANGELOG with cargo-release
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  # cargo-release will update CHANGELOG, commit, and tag
                  cargo release ${{ steps.version.outputs.version }} \
                    --execute \
                    --no-confirm \
                    --no-publish \
                    --no-push
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
            
            - name: Push changes and tags
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  git push origin main
                  git push origin v${{ steps.version.outputs.version }}

            - name: Build WASM for release
              if: steps.check_tag.outputs.exists == 'false'
              run: wasm-pack build --target web --out-dir ./pkg --release --features wasm

            - name: Create WASM package artifact
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  cd pkg
                  tar -czf ../orb-groth16-proof.tar.gz .
                  cd ..
                  ls -lh orb-groth16-proof.tar.gz

            - name: Create GitHub Release and Tag
              if: steps.check_tag.outputs.exists == 'false'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.version }}
                  files: orb-groth16-proof.tar.gz
                  draft: false
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Publish to crates.io
              if: steps.check_tag.outputs.exists == 'false'
              run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
